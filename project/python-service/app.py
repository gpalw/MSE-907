# python-service/app.py
from fastapi import FastAPI, APIRouter, HTTPException
import pandas as pd
import boto3
import os
from pathlib import Path
from io import StringIO
import uvicorn

CACHE_BASE = Path(__file__).resolve().parent / "tmp"
CACHE_BASE.mkdir(exist_ok=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ä¸šåŠ¡é€»è¾‘å‡½æ•°å…¨éƒ¨æ¥è‡ª prediction.py
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from prediction import (
    preprocess_data,  # æ¸…æ´— + è®¡ç®— DTW
    select_model,  # æ ¹æ® DTW é€‰æ‹© TFT or Fallback
    predict_sales,  # æ‰§è¡Œé¢„æµ‹
    validate_history,  # éªŒè¯å†å²æ•°æ®æ˜¯å¦ç¬¦åˆè¦æ±‚
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# FastAPI åˆå§‹åŒ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = FastAPI(title="SME Forecasting API")
router = APIRouter()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# S3 é…ç½®ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡è¦†å†™æ›´å®‰å…¨ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AWS_REGION = os.getenv("AWS_REGION", "ap-southeast-2")
S3_BUCKET = os.getenv("S3_BUCKET", "web-forecast-data")

s3 = boto3.client("s3", region_name=AWS_REGION)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å·¥å…·ï¼šä» S3 è¯»å– CSV â†’ DataFrame
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def fetch_csv_cached(key: str) -> pd.DataFrame:
    local_path = CACHE_BASE / key
    local_path.parent.mkdir(parents=True, exist_ok=True)

    if local_path.exists():
        print(f"âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­: {local_path}")
        return pd.read_csv(local_path, parse_dates=["date"])

    try:
        obj = s3.get_object(Bucket=S3_BUCKET, Key=key)
    except s3.exceptions.NoSuchKey:
        raise HTTPException(status_code=404, detail=f"S3 Key not found: {key}")

    # å†™å…¥æœ¬åœ°ç¼“å­˜
    csv_str = obj["Body"].read().decode("utf-8")
    local_path.write_text(csv_str, encoding="utf-8")
    print(f"â¬‡ï¸ å·²ä» S3 ä¸‹è½½å¹¶ç¼“å­˜åˆ°: {local_path}")

    return pd.read_csv(StringIO(csv_str), parse_dates=["date"])


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è·¯ç”±ï¼šæ£€æŸ¥æ–‡ä»¶
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# @router.get("/fetch-file")
# async def fetch_file(key: str):
#     """
#     ç®€å•è¯»å– S3 ä¸Šçš„ CSVï¼Œè¿”å›è¡Œæ•°å’Œåˆ—åï¼Œä¾›å‰ç«¯å¿«é€Ÿæ£€æŸ¥ã€‚
#     """
#     df = fetch_csv_from_s3(key)
#     return {"s3_key": key, "rows": len(df), "columns": df.columns.tolist()}


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è·¯ç”±ï¼šæ ¸å¿ƒé¢„æµ‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.get("/predict")
def predict(key: str, horizon: int = 7):
    """
    è¯»å–ç”¨æˆ· CSV â†’ é¢„å¤„ç† â†’ DTW ç›¸ä¼¼åº¦åˆ¤æ–­ â†’ é€‰æ‹©æ¨¡å‹ â†’ é¢„æµ‹æœªæ¥ N å¤©ã€‚
    """
    # Step 1: åŠ è½½æ•°æ®
    df = fetch_csv_cached(key)

    validate_history(df)

    # Step 2: æ•°æ®é¢„å¤„ç† + DTW åˆ¤æ–­
    preprocessed_df, can_use_tft = preprocess_data(df)

    # Step 3: æ ¹æ® DTW é€‰æ‹©æ¨¡å‹
    model, model_type = select_model(can_use_tft)

    # Step 4: æ‰§è¡Œé¢„æµ‹
    preds = predict_sales(model, preprocessed_df, steps=horizon, model_type=model_type)

    return {
        "model_used": model_type,  # "TFT" or "Fallback"
        "predicted_sales": preds,  # æœªæ¥ horizon å¤©çš„é”€é‡é¢„æµ‹
    }


# å°†æ‰€æœ‰è·¯ç”±æŒ‚åˆ° "/py" å‰ç¼€ä¸‹
app.include_router(router, prefix="/py")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Docker / æœ¬åœ°è¿è¡Œå…¥å£
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    import debugpy

    debugpy.listen(("0.0.0.0", 5678))  # ç«¯å£éšæ„
    print("ğŸ”— ç­‰å¾… VSCode è¿æ¥è°ƒè¯•å™¨â€¦")
    # ç›‘å¬æ‰€æœ‰ç½‘å¡ï¼Œç«¯å£ 8000
    uvicorn.run("app:app", host="0.0.0.0", port=8000, log_level="info")
